# Implementation Plan: Class Leader Attendance Delegation

**Branch**: `001-class-leader-attendance` | **Date**: 2025-11-09 | **Spec**: `specs/001-class-leader-attendance/spec.md`
**Input**: Feature specification from `specs/001-class-leader-attendance/spec.md`

## Summary

Implement a session-based attendance delegation workflow inside `attendance-service` so teachers can delegate collection to class leaders, leaders can submit attendance, and teachers can approve or reject the results. Replace the ad-hoc `setup-keycloak.sh` bash script with a Kotlin-based initializer that runs automatically during `user-service` startup. The initializer must detect whether Keycloak is already provisioned and exit without changes when the realm/client/role configuration is present, guaranteeing idempotent behavior across restarts.

## Technical Context

**Language/Version**: Kotlin 2.2.21 with Spring Boot 3.5.7 (Attendance Service, Academic Service, User Service); Kotlin starter for Keycloak initializer executed from user-service startup hook  
**Primary Dependencies**: Spring Boot Web/Data/Security, Spring Cloud (Config, Eureka), Keycloak Spring Security adapter, Flyway, RabbitMQ client, Keycloak Admin REST client (official `keycloak-admin-client`)  
**Storage**: PostgreSQL 17 schemas managed via Flyway (attendance, academic); Keycloak 24.0.0 for IAM  
**Testing**: JUnit 5, Mockito, Testcontainers (PostgreSQL, Keycloak container for initializer verification)  
**Target Platform**: Dockerized microservices on Linux, fronted by API Gateway + Keycloak; Keycloak initializer executes inside user-service pod/container during Spring Boot bootstrap  
**Project Type**: Backend microservices + embedded security bootstrap module  
**Performance Goals**: Meet spec success criteria (delegation <30s, collection <5m, approval <2m, 95% same-day approval, immediate authorization checks); initializer must finish <15s during service startup  
**Constraints**: Enforce Keycloak RBAC/permission checks consistently; initializer MUST be idempotent with explicit “already initialized” detection to keep user-service startup fast; avoid blocking user-service readiness if Keycloak unavailable (retry with backoff)  
**Scale/Scope**: Up to 500 classes, 3 class leaders per class, ~10k students, multi-tenant realm support for future expansion; initializer should support environment-specific realms via config

## Constitution Check

- **I. Security & Authentication**: Keycloak permissions (COLLECT_ATTENDANCE, MANAGE_ATTENDANCE) provisioned during user-service startup using secure credentials from Config Server/Vault; initializer enforces no plaintext secrets. ✅
- **II. Microservices Architecture**: Attendance and academic enhancements remain isolated; user-service gains a bootstrap component but no cross-database access; initializer only interacts with Keycloak via REST. ✅
- **III. Event-Driven Communication**: Session lifecycle events handled as planned; initializer emits no events and logs to audit instead. ✅
- **IV. Test-First Development**: Plan includes unit/integration tests for services, controller flows, and initializer (Testcontainers Keycloak) executed before implementation. ✅
- **V. Configuration Management**: Initializer configuration sourced from encrypted Config Server; `user-service` startup uses environment profiles—no hardcoded secrets. ✅
- **VI. Comprehensive Documentation**: OpenAPI contracts, event schemas, quickstart, and initializer bootstrap docs updated to reflect new startup behavior. ✅

No constitutional violations identified; Complexity Tracking remains empty.

## Project Structure

```text
specs/001-class-leader-attendance/
├── plan.md              # This plan
├── research.md          # Phase 0 decisions (updated for startup hook)
├── data-model.md        # Phase 1 entity design + Keycloak blueprint
├── quickstart.md        # Startup + test instructions
├── contracts/           # OpenAPI + event schema updates
└── tasks.md             # Generated by /speckit.tasks
```

```text
services/user-service/
├── src/main/kotlin/com/visor/school/userservice/
│   ├── bootstrap/       # New KeycloakInitializerRunner (ApplicationRunner)
│   ├── config/          # Keycloak initializer properties binding & retry config
│   └── security/        # Existing security configuration (updated to wire initializer)
├── src/test/kotlin/com/visor/school/userservice/
│   └── bootstrap/       # Initializer integration tests (Testcontainers Keycloak)
└── resources/
    └── application.yml  # Profiles for initializer enable/disable

services/attendance-service/
├── src/main/kotlin/com/visor/school/attendanceservice/
│   ├── controller/      # Attendance session endpoints
│   ├── service/         # Session, delegation, collection, approval services
│   ├── model/           # AttendanceSession, AttendanceRecord updates
│   ├── event/           # RabbitMQ publishers for delegation lifecycle
│   └── security/        # Permission evaluators using Keycloak claims
├── src/main/resources/db/migration/   # Flyway scripts for session workflow
└── src/test/kotlin/com/visor/school/attendanceservice/
    ├── service/
    ├── controller/
    └── integration/

services/academic-service/
├── src/main/kotlin/com/visor/school/academicservice/
│   ├── model/           # StudentClassLeadership entity
│   ├── controller/      # Class leader assignment endpoints
│   └── service/         # Assignment service with Keycloak sync hooks
└── src/test/kotlin/com/visor/school/academicservice/
    └── integration/

services/common/
└── src/main/kotlin/com/visor/school/common/
    └── security/        # Shared Keycloak/permission utilities consumed by services

shared/keycloak-initializer-core/
├── pom.xml              # New Maven library module with provisioning logic
├── src/main/kotlin/com/visor/school/keycloak/
│   ├── InitializerService.kt          # Provisioning operations
│   ├── model/                         # Realm/client/role definitions
│   └── detection/                     # Already-initialized checks & metrics
└── src/test/kotlin/com/visor/school/keycloak/
    └── InitializerServiceTest.kt      # Unit tests (mocked client)
```

**Structure Decision**: Extract provisioning logic into reusable `shared/keycloak-initializer-core` library consumed by `user-service` at startup. Future CLI/automation can still reuse the same module while the service-level bootstrap guarantees environments stay configured without manual scripts.

## Complexity Tracking

_No constitutional deviations._
